import { Article } from "@/lib/rss-parser";
import ArticleCard from "@/components/ArticleCard";
import AdsterraAds from "@/components/AdsterraAds";
import MarketTicker from "@/components/MarketTicker";
import {
  HeroNewsletterSignup,
  CompactNewsletterSignup,
  FloatingNewsletterSignup,
} from "@/components/NewsletterSignup";
import {
  StructuredData,
  websiteStructuredData,
  organizationStructuredData,
} from "@/components/SEOHead";
import { generateBreadcrumbSchema } from "@/lib/metadata";

  isFeatured?: boolean;
}

// Force dynamic rendering with revalidation
export const dynamic = 'force-dynamic';
export const revalidate = 60;

async function getArticles(): Promise<Article[]> {
  try {
    const response = await fetch('http://localhost:3000/api/articles', {
      next: { revalidate: 60 },
      headers: { 'Content-Type': 'application/json' },
      cache: 'no-store',
    });
    
    if (!response.ok) {
      console.error(`API returned ${response.status}`);
      return [];
    }
    
    const data = await response.json();
    return data.success ? data.articles : [];
  } catch (err) {
    console.error('Failed to load articles:', err);
    return [];
  }
}

/**
 * Homepage for Bali Report - BRICS-aligned news aggregation.
 * Server-side component that fetches articles at request time.
 */
export default async function Home() {
  const articles = await getArticles();
  
  // Split into featured and regular articles
  const featuredArticles = articles.filter(a => a.isFeatured).slice(0, 3);
  const regularArticles = articles.filter(a => !a.isFeatured);

  // Breadcrumb structured data
  const breadcrumbData = generateBreadcrumbSchema([
    { name: "Home", url: "https://bali.report" },
  ]);

  return (
    <>
      <StructuredData data={websiteStructuredData} />
      <StructuredData data={organizationStructuredData} />
      <StructuredData data={breadcrumbData} />

      <div className="min-h-screen bg-gradient-to-br from-zinc-900 via-zinc-800 to-zinc-900">
        {/* Market Ticker */}
        <MarketTicker />

        {/* Hero Section with Newsletter */}
        <div className="relative overflow-hidden bg-gradient-to-r from-teal-900/20 to-blue-900/20 border-b border-teal-800/30">
          <div className="absolute inset-0 bg-grid-pattern opacity-5"></div>
          <div className="container mx-auto px-4 py-16 relative z-10">
            <div className="max-w-4xl mx-auto text-center">
              <h1 className="text-5xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500 mb-6">
                News Without Borders
              </h1>
              <p className="text-xl text-zinc-300 mb-8 leading-relaxed">
                Breaking free from Western media monopoly. Real-time aggregation
                from BRICS-aligned sources, Indonesian insights, and multipolar
                perspectives.
              </p>
              <HeroNewsletterSignup />
            </div>
          </div>
        </div>

        <main className="container mx-auto px-4 py-12">
          {/* Featured Articles */}
          {featuredArticles.length > 0 && (
            <section className="mb-16">
              <h2 className="text-3xl font-bold text-teal-400 mb-8 flex items-center">
                <span className="mr-3">‚≠ê</span>
                Featured Stories
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {featuredArticles.map((article) => (
                  <ArticleCard key={article.id} article={article} featured />
                ))}
              </div>
            </section>
          )}

          {/* Ad Section */}
          <div className="my-12">
            <AdsterraAds />
          </div>

          {/* Latest Articles */}
          <section>
            <h2 className="text-3xl font-bold text-teal-400 mb-8 flex items-center">
              <span className="mr-3">üì∞</span>
              Latest Articles
            </h2>

            {articles.length === 0 ? (
              <div className="text-center py-20">
                <div className="inline-block animate-spin rounded-full h-16 w-16 border-4 border-teal-600 border-t-transparent mx-auto mb-6"></div>
                <p className="text-zinc-400 text-lg">Loading latest news...</p>
              </div>
            ) : (
              <>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {regularArticles.slice(0, 12).map((article) => (
                    <ArticleCard key={article.id} article={article} />
                  ))}
                </div>

                {/* Compact Newsletter Signup */}
                <div className="my-16">
                  <CompactNewsletterSignup />
                </div>

                {/* More Articles */}
                {regularArticles.length > 12 && (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                    {regularArticles.slice(12, 30).map((article) => (
                      <ArticleCard key={article.id} article={article} />
                    ))}
                  </div>
                )}

                {/* Bottom Ad */}
                <div className="my-12">
                  <AdsterraAds />
                </div>

                {/* Remaining Articles */}
                {regularArticles.length > 30 && (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8">
                    {regularArticles.slice(30).map((article) => (
                      <ArticleCard key={article.id} article={article} />
                    ))}
                  </div>
                )}
              </>
            )}
          </section>
        </main>

        {/* Floating Newsletter */}
        <FloatingNewsletterSignup />
      </div>
    </>
  );
}
